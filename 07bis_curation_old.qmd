
## Composition of SAT


```{r}
library(tidyverse)
library(sf)
library(tmap)
library(arrow)
library(geoarrow)

# Load the consolidated data
all_PAs_conso <- read_rds("data/id/all_PAs_conso.rds")

pa_decisions <- read_rds("data/id/legal_texts.rds")

modification_decisions <- pa_decisions |>
  filter(str_detect("modifiant", type_decision))

modification_decision_names <- unique(modification_decisions$WDPA_NAME) |>
  sort()
modification_decision_names
```

We have `r length(modification_decision_names)` border modification decisions registered.

```{r}
# 2 functions: 1 for exploratory data analysis, the other to display identified
# datasets

# Function to visualize all representations of a PA by WDPA name
# Looks up the WDPAID from pa_decisions, then filters all_PAs_conso by that ID
# Each row becomes a separately controllable layer
visualize_pa_by_name <- function(
  wdpa_name,
  data = all_PAs_conso,
  decisions = pa_decisions,
  wdpa_historical_path = "data/MDG_WDPA_Consolidated.parquet",
  sources = NULL
) {
  # Check if input is a WDPAID (integer) or name (string)
  if (is.numeric(wdpa_name)) {
    wdpaid <- wdpa_name
  } else {
    # Look up the WDPAID from pa_decisions
    wdpaid <- decisions %>%
      filter(WDPA_NAME == wdpa_name) %>%
      pull(WDPAID) %>%
      first()

    # Check if WDPAID was found
    if (is.na(wdpaid)) {
      message("No WDPAID found in pa_decisions for: ", wdpa_name)
      return(NULL)
    }
  }

  # Filter all observations matching this WDPAID from all_PAs_conso
  pa_subset <- data %>%
    filter(WDPAID == wdpaid) %>%
    mutate(layer_id = paste0(dataset_id, " - ", row_number()))

  # Load and filter WDPA historical data
  wdpa_historical <- read_parquet(wdpa_historical_path) %>%
    mutate(geometry = st_as_sfc(geometry)) %>%
    st_as_sf() %>%
    filter(WDPAID == wdpaid) %>%
    mutate(dataset_id = paste0("WDPA_", data_year)) %>%
    st_transform(st_crs(pa_subset))

  # Combine both datasets
  pa_subset <- bind_rows(pa_subset, wdpa_historical)

  # Filter by specified sources if provided
  if (!is.null(sources) && length(sources) > 0) {
    pa_subset <- pa_subset %>%
      filter(dataset_id %in% sources) %>%
      # Convert to factor with levels in the order specified by sources
      mutate(dataset_id = factor(dataset_id, levels = sources))
  }

  # Check if any results found
  if (nrow(pa_subset) == 0) {
    message("No protected area found with WDPAID: ", wdpaid)
    return(NULL)
  }

  # Get summary information
  n_obs <- nrow(pa_subset)
  datasets <- unique(pa_subset$dataset_id)

  # Print summary
  cat("\n=== ", wdpa_name, " ===\n")
  cat("WDPAID:", wdpaid, "\n")
  cat("Number of representations:", n_obs, "\n")
  cat("Datasets:", paste(datasets, collapse = ", "), "\n\n")

  # Create static plot map with all geometries in one layer (tmap v4 syntax)
  tmap_mode("view")

  map <- NULL

  # Add each row as a separate shape layer
  for (i in seq_len(nrow(pa_subset))) {
    row_data <- pa_subset[i, ]
    layer_name <- paste0(row_data$dataset_id, " (", i, ")")

    if (is.null(map)) {
      map <- tm_shape(row_data, name = layer_name) +
        tm_polygons(
          col = "dataset_id",
          alpha = 0.4,
          id = "layer_id",
          popup.vars = c(
            "NAME",
            "WDPA_NAME",
            "dataset_id",
            "overlap_WDPA",
            "STATUS_YR",
            "DESIG",
            "IUCN_CAT",
            "date_texte",
            "type_texte",
            "num_texte"
          ),
          palette = "Set3",
          title = "Data Source",
          group = layer_name
        )
    } else {
      map <- map +
        tm_shape(row_data, name = layer_name) +
        tm_polygons(
          col = "dataset_id",
          alpha = 0.4,
          id = "layer_id",
          popup.vars = c(
            "NAME",
            "WDPA_NAME",
            "dataset_id",
            "STATUS_YR",
            "DESIG",
            "IUCN_CAT",
            "date_texte",
            "type_texte",
            "num_texte"
          ),
          palette = "Set3",
          title = "Data Source",
          group = layer_name
        )
    }
  }

  map <- map +
    tm_layout(
      title = paste(wdpa_name, "- All representations"),
      frame = FALSE
    )

  return(map)
}

plot_pa_by_name <- function(
  wdpa_name,
  data = all_PAs_conso,
  decisions = pa_decisions,
  wdpa_historical_path = "data/MDG_WDPA_Consolidated.parquet",
  sources = NULL
) {
  # Check if input is a WDPAID (integer) or name (string)
  if (is.numeric(wdpa_name)) {
    wdpaid <- wdpa_name
  } else {
    # Look up the WDPAID from pa_decisions
    wdpaid <- decisions %>%
      filter(WDPA_NAME == wdpa_name) %>%
      pull(WDPAID) %>%
      first()

    # Check if WDPAID was found
    if (is.na(wdpaid)) {
      message("No WDPAID found in pa_decisions for: ", wdpa_name)
      return(NULL)
    }
  }

  # Filter all observations matching this WDPAID from all_PAs_conso
  pa_subset <- data %>%
    filter(WDPAID == wdpaid)

  # Load and filter WDPA historical data
  wdpa_historical <- read_parquet(wdpa_historical_path) %>%
    mutate(geometry = st_as_sfc(geometry)) %>%
    st_as_sf() %>%
    filter(WDPAID == wdpaid) %>%
    mutate(dataset_id = paste0("WDPA_", data_year)) %>%
    st_transform(st_crs(pa_subset))

  # Combine both datasets
  pa_subset <- bind_rows(pa_subset, wdpa_historical)

  # Filter by specified sources if provided
  if (!is.null(sources) && length(sources) > 0) {
    pa_subset <- pa_subset %>%
      filter(dataset_id %in% sources) %>%
      # Convert to factor with levels in the order specified by sources
      mutate(dataset_id = factor(dataset_id, levels = sources))
  }

  # Check if any results found
  if (nrow(pa_subset) == 0) {
    message("No protected area found with WDPAID: ", wdpaid)
    return(NULL)
  }

  # Get summary information
  n_obs <- nrow(pa_subset)
  datasets <- unique(pa_subset$dataset_id)

  # Print summary
  cat("\n=== ", wdpa_name, " ===\n")
  cat("WDPAID:", wdpaid, "\n")
  cat("Number of representations:", n_obs, "\n")
  cat("Datasets:", paste(datasets, collapse = ", "), "\n\n")

  # Create static plot map with all geometries in one layer (tmap v4 syntax)
  tmap_mode("plot")

  map <- tm_shape(pa_subset) +
    tm_polygons(
      fill = "dataset_id",
      fill_alpha = 0.5,
      col = "black",
      lwd = 1,
      fill.scale = tm_scale(values = "brewer.set2"),
      fill.legend = tm_legend(
        title = "Data Source",
        position = tm_pos_out("right")
      )
    ) +
    tm_title(wdpa_name)

  return(map)
}
```

## Ambatovaky

```{r}
ambatovaky_decision_2015 <- pa_decisions %>%
  filter(WDPAID == 5037, year(date_texte) == 2015) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(ambatovaky_decision_2015, -objet_texte),
  ambatovaky_decision_2015$objet_texte
))
```


```{r}
#| echo: false
#| eval: false
visualize_pa_by_name(
  "Ambatovaky",
  sources = c("WDPA_2025", "MNP_2010", "ANGAP_2002")
)
```


```{r}
plot_pa_by_name(
  "Ambatovaky",
  sources = c("ANGAP_2002", "MNP_2010", "WDPA_2025")
)
```

3 different perimeters: 
- WDPA 2025
- WDPA 2024 : much larger than WDPA 2025 (includes protection zone?)
- WDPA < 2020 | ANGAP 2002: smaller than WPDA 2025

> To be added to SAT: ANGAP_2002

## Analamazaotra 

```{r}
analamazotra_decision_2015 <- pa_decisions %>%
  filter(WDPAID == 5021) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(analamazotra_decision_2015, -objet_texte),
  analamazotra_decision_2015$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Analamazaotra")
```

```{r}
plot_pa_by_name(
  "Analamazaotra",
  sources = c("WDPA_2025", "SAPM_2010", "WDPA_2024")
)
```

different peremetrs
- WDPA 2025
- WDPA 2020:2024: larger (includes protection zone?)
- SAPM 2010 (and others) smaller and clearer borders

> To be added to SAT: SAPM 2010

## Andohahela 

```{r}
andohahela_decision_2015 <- pa_decisions %>%
  filter(WDPAID == 2303) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(andohahela_decision_2015, -objet_texte),
  andohahela_decision_2015$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Andohahela")
```

Three different versions
- WDPA 2025 = SAPM 2024 = SAPM 2017
- WDPA 2024 = 
- ANGAP 2002 = WDPA <= 2016

```{r}
plot_pa_by_name(
  "Andohahela",
  sources = c("WDPA_2025", "ANGAP_2002", "WDPA_2024")
)
```


## Andringitra

```{r}
andringitra_decision_2015 <- pa_decisions %>%
  filter(WDPAID == 2308) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(andringitra_decision_2015, -objet_texte),
  andringitra_decision_2015$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Andringitra")
```

- WDPA 2025 = SAPM 2017 = SAPM 2025 = Vahatra
- WDPA 2020:2024 = trop large (inclut la zone de protection probablement)
- WDPA 2010:2019: frontières plus simples qu'on ne retrouve avec des différences modérées avec la plupart des autres sources
- ANGAP 2002 = SAPM 2010 = SAPM evol 2001-2011 (avec year = 2002)

```{r}
plot_pa_by_name(
  "Andringitra",
  sources = c("WDPA_2025", "ANGAP_2002")
)
```

> Garder ANGAP_2002

## Anjanaharibe_sud

```{r}
anjanaharibe_decision_2015 <- pa_decisions %>%
  filter(WDPAID == 5023) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(anjanaharibe_decision_2015, -objet_texte),
  anjanaharibe_decision_2015$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Anjanaharibe_sud")
```

- WDPA 2025 = WPDA 2024 = WDPA 2017 = Vahatra
- WDPA 2010:2019 = ANGAP 2002
- WDPA 2024 semble très faux.
- SAPM 2010 = SAPM 2001-2011 très différent

```{r}
plot_pa_by_name(
  "Anjanaharibe_sud",
  sources = c("WDPA_2025", "ANGAP_2002")
)
```

> Ajouter ANGAP 2002

## Ankarafantsika

```{r}
ankarafantsika_decision_2015 <- pa_decisions %>%
  filter(WDPAID == 1299) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(ankarafantsika_decision_2015, -objet_texte),
  ankarafantsika_decision_2015$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Ankarafantsika")
```

- ANGAP 2002 = SAPM 2010:2019
- WDPA 2025 = SAPM 2010, 2017, 2024
- WDPA 2024 inclut la zone de protection

```{r}
plot_pa_by_name(
  "Ankarafantsika",
  sources = c("WDPA_2025", "ANGAP_2002")
)
```

> Ajout de ANGAP 2002

The extension of the protected area in 2002 was mapped as follows in 2002 by experts from the NGO Conservation International, which spearheaded the initiative.

![Ankarafantsika 2002 expansion](data/Alonso_Shuldenberg_2002.png)

## Bemaraha 

```{r}
bemaraha_decision <- pa_decisions %>%
  filter(WDPAID == 303702) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(bemaraha_decision, -objet_texte),
  bemaraha_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name(303702)
```

- ANGAP 2002 (périmètre Sud) = WDPA 2010:2019
- ANGAP 2002 (périmètre Nord) 
- ANGAP 2002 (très petit périmètre centre) dans aucun autre


> Ajouter SAPM 2010 ou version MNP


```{r}
plot_pa_by_name(
  303702,
  sources = c("WDPA_2025") # Update after visual inspection
)
```

## Beza Mahafaly

```{r}
beza_decision <- pa_decisions %>%
  filter(WDPAID == 10634) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(beza_decision, -objet_texte),
  beza_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Beza Mahafaly")
```

```{r}
plot_pa_by_name(
  10634,
  sources = c("WDPA_2025") # Update after visual inspection
)
```

## Cap Sainte Marie

```{r}
cap_decision <- pa_decisions %>%
  filter(WDPAID == 5041) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(cap_decision, -objet_texte),
  cap_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Cap Sainte Marie")
```

```{r}
plot_pa_by_name(
  5041,
  sources = c("WDPA_2025") # Update after visual inspection
)
```

## Kirindy Mite

```{r}
kirindy_decision <- pa_decisions %>%
  filter(WDPAID == 303700) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(kirindy_decision, -objet_texte),
  kirindy_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Kirindy Mite")
```

```{r}
plot_pa_by_name(
  303700,
  sources = c("WDPA_2025") # Update after visual inspection
)
```

## Mangerivola

```{r}
mangerivola_decision <- pa_decisions %>%
  filter(WDPAID == 5038) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(mangerivola_decision, -objet_texte),
  mangerivola_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Mangerivola")
```

```{r}
plot_pa_by_name(
  5038,
  sources = c("WDPA_2025") # Update after visual inspection
)
```

## Manombo

```{r}
manombo_decision <- pa_decisions %>%
  filter(WDPAID == 5028) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(manombo_decision, -objet_texte),
  manombo_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Manombo")
```

```{r}
plot_pa_by_name(
  5028,
  sources = c("WDPA_2025") # Update after visual inspection
)
```

## Manongarivo

```{r}
manongarivo_decision <- pa_decisions %>%
  filter(WDPAID == 5026) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(manongarivo_decision, -objet_texte),
  manongarivo_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Manongarivo")
```

```{r}
plot_pa_by_name(
  5026,
  sources = c("WDPA_2025") # Update after visual inspection
)
```

## Mantadia

```{r}
mantadia_decision <- pa_decisions %>%
  filter(WDPAID == 26070) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(mantadia_decision, -objet_texte),
  mantadia_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Mantadia")
```

```{r}
plot_pa_by_name(
  26070,
  sources = c("WDPA_2025") # Update after visual inspection
)
```

## Marojejy

```{r}
marojejy_decision <- pa_decisions %>%
  filter(WDPAID == 2305) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(marojejy_decision, -objet_texte),
  marojejy_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Marojejy")
```

```{r}
plot_pa_by_name(
  2305,
  sources = c("WDPA_2025") # Update after visual inspection
)
```

## Montagne d'Ambre

```{r}
montagne_decision <- pa_decisions %>%
  filter(WDPAID == 2314) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(montagne_decision, -objet_texte),
  montagne_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Montagne d'Ambre")
```

```{r}
plot_pa_by_name(
  2314,
  sources = c("WDPA_2025") # Update after visual inspection
)
```

## Namoroka

```{r}
namoroka_decision <- pa_decisions %>%
  filter(WDPAID == 2309) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(namoroka_decision, -objet_texte),
  namoroka_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Namoroka")
```

```{r}
plot_pa_by_name(
  2309,
  sources = c("WDPA_2025") # Update after visual inspection
)
```

## Nosy Mangabe

```{r}
nosy_decision <- pa_decisions %>%
  filter(WDPAID == 5039) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(nosy_decision, -objet_texte),
  nosy_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Nosy Mangabe")
```

```{r}
plot_pa_by_name(
  5039,
  sources = c("WDPA_2025") # Update after visual inspection
)
```

## Tsimanampesotse

```{r}
tsimanampesotse_decision <- pa_decisions %>%
  filter(WDPAID == 2307) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(tsimanampesotse_decision, -objet_texte),
  tsimanampesotse_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Tsimanampesotse")
```

```{r}
plot_pa_by_name(
  2307,
  sources = c("WDPA_2025") # Update after visual inspection
)
```

## Zahamena

```{r}
zahamena_decision <- pa_decisions %>%
  filter(WDPAID == 354013) %>%
  select(date_texte, type_texte, type_decision, id_texte, objet_texte)
print(list(
  select(zahamena_decision, -objet_texte),
  zahamena_decision$objet_texte
))
```

```{r}
#| echo: false
#| eval: false
visualize_pa_by_name("Zahamena")
```


```{r}
plot_pa_by_name(
  354013,
  sources = c("WDPA_2025") # Update after visual inspection
)
```